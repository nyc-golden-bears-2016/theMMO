console.log("SOCKET PAGE LOADING")
var setUpWebsocket = function(scheme){

  var uri = scheme + window.document.location.host + "/";
  wSocket = new WebSocket(uri);


  wSocket.onmessage = function(response) {
    var data = JSON.parse(response.data);
    if (data.logout === true) {
      var deleteIndex = playerNames.indexOf(data.username);
      playerNames.splice(deleteIndex, 1);
    } else if(data.username !== your_character_name) {

      // if username is not found, add it to existing users
      if (playerNames.indexOf(data.username) === -1) {
        playerNames.push(data.username);
        // initialize an object to store this player's info
        otherPlayers[data.username] = new Character(data.username);
      };
      otherPlayers[data.username].pos_x = data.pos_x;
      otherPlayers[data.username].pos_y = data.pos_y;
      if (data.requestPartyWith === your_character_name){
        // if received party request
        if (confirm(data.username + ' requests to party with you')===true) {
          console.log("PARTY INITIATE");
          console.log(data.username);
        }
      } else if (data.requestTradeWith === your_character_name){
        if (confirm(data.username + ' requests to trade with you')===true) {
          console.log("TRADE INITIATE");
        }
      }
    };
  };
};

var updateCharacters = function(){
  if(wSocket.readyState === 1) {
    if(partyMembers.length < 1) {  // no party members
      wSocket.send( JSON.stringify({logout: false, pos_x: your_char.pos_x, pos_y: your_char.pos_y, username: your_character_name, requestPartyWith: otherPlayertoPartyWith, requestTradeWith: otherPlayertoTradeWith}) );
    } else { // in party
      wSocket.send( JSON.stringify({logout: false, pos_x: your_char.pos_x, pos_y: your_char.pos_y, username: your_character_name, requestPartyWith: otherPlayertoPartyWith, requestTradeWith: otherPlayertoTradeWith}) );
    }
    otherPlayertoPartyWith = "";
    otherPlayertoTradeWith = "";
  };
};

var setCharacterUpdate = function(character_name) {
    your_character_name = character_name;
    setInterval(updateCharacters, FRAME_RATE/1.5);
};

var logout = function() {
  wSocket.send( JSON.stringify({logout: true, username: your_character_name}) );
};

var setAutoLogout = function() {
  $( window ).unload(logout);
};
