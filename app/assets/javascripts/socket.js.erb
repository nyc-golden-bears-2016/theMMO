console.log("SOCKET PAGE LOADING")
var setUpWebsocket = function(scheme){

  var uri = scheme + window.document.location.host + "/";
  wSocket = new WebSocket(uri);


  wSocket.onmessage = function(response) {
    var data = JSON.parse(response.data);
    if (data.logout === true) {
      var deleteIndex = playerNames.indexOf(data.username);
      playerNames.splice(deleteIndex, 1);
    } else if(data.username !== your_character_name) {

      // if username is not found, add it to existing users
      if (playerNames.indexOf(data.username) === -1) {
        playerNames.push(data.username);
        // initialize an object to store this player's info
        otherPlayers[data.username] = new Character(data.username);
      };
      otherPlayers[data.username].pos_x = data.pos_x;
      otherPlayers[data.username].pos_y = data.pos_y;
      // party logic
      if (data.partyMembers.indexOf(your_character_name) !== -1) {
        for (var i = data.partyMembers.length - 1; i >= 0; i--) {
          if(partyMembers.indexOf(data.partyMembers[i]) === -1) {
            partyMembers.push(data.partyMembers[i]);
          };
        };
        if(partyMembers.indexOf(data.username) === -1) {
          partyMembers.push(data.username);
        };
      }
      if (data.requestPartyWith === your_character_name){
        // if received party request
        if (confirm(data.username + ' requests to party with you')===true) {
          partyMembers.push(data.username);
        }
      // trade logic
      } else if (data.requestTradeWith === your_character_name){
        if (confirm(data.username + ' requests to trade with you')===true) {
          console.log("TRADE INITIATE");
        }
      }
      // party battles
      if (data.partyMembers.indexOf(your_character_name) !== -1 && data.currentEnemies.length > 0 && inBattle === false && battleOver === true){
        var teamBattleEnemies = [];
        for (var i = data.currentEnemies.length - 1; i >= 0; i--) {
          teamBattleEnemies.push(enemyMake(data.currentEnemies[i].name));
        };
        currentEnemies = teamBattleEnemies;
        prepareTeamBattle(currentEnemies);
      };

      // syncs enemy health between members in party
      if (data.inBattle === true && data.partyMembers.indexOf(your_character_name) !== -1){
        for (var i = data.currentEnemies.length - 1; i >= 0; i--) {
          if(data.currentEnemies[i].health < currentEnemies[i].health) {
            currentEnemies[i].health = data.currentEnemies[i].health;
          }
        };
      }
      // if (data.partyMembers.indexOf(your_character_name) !== -1 && data.battleOver === true) {
      //   for (var i = currentEnemies.length - 1; i >= 0; i--) {
      //     currentEnemies[i].health = 0;
      //   };
      // }
      if (data.partyMembers.indexOf(your_character_name) !== -1 && data.slashPos !== -1 && inBattle === true && battleOver === false) {
        console.log(data.slashPos);
        console.log(currentEnemies[data.slashPos]);
        slashes.push(new Slash(currentEnemies[data.slashPos]));
      }
    };
  };
};

var updateCharacters = function(){
  if(wSocket.readyState === 1) {
    if(partyMembers.length < 1) {  // no party members
      wSocket.send( JSON.stringify({logout: false, pos_x: your_char.pos_x, pos_y: your_char.pos_y, username: your_character_name, requestPartyWith: otherPlayertoPartyWith, requestTradeWith: otherPlayertoTradeWith, partyMembers: partyMembers}) );
    } else { // in party
      wSocket.send( JSON.stringify({logout: false, pos_x: your_char.pos_x, pos_y: your_char.pos_y, username: your_character_name, requestPartyWith: otherPlayertoPartyWith, requestTradeWith: otherPlayertoTradeWith, partyMembers: partyMembers, currentEnemies: currentEnemies, inBattle: inBattle, battleOver: battleOver, slashPos: slashPos}) );
    }
    slashPos = -1;
    otherPlayertoPartyWith = "";
    otherPlayertoTradeWith = "";
  };
};

var setCharacterUpdate = function(character_name) {
    your_character_name = character_name;
    setInterval(updateCharacters, FRAME_RATE/1.5);
};

var logout = function() {
  wSocket.send( JSON.stringify({logout: true, username: your_character_name}) );
};

var setAutoLogout = function() {
  $( window ).unload(logout);
};
